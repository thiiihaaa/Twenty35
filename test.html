<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Twenty35 Chat</title>
    <style>
        /* General Reset and Base Styles */
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            background:#000;
            color:#fff;
            font-family:Arial, sans-serif;
            height:100vh;
            display:flex;
            flex-direction:column;
            overflow:hidden;
        }

        /* Header/Top Bar */
        header {
            width:100%;
            padding:1rem;
            display:flex;
            justify-content:space-between;
            align-items:center;
            background:#111;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        #leftIcons {
            display:flex;
            gap:1rem;
            align-items:center;
        }

        #commentIcon, #userGuide {
            cursor:pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.3s;
        }
        #commentIcon:hover, #userGuide:hover {
             background: #333;
        }

        /* Overlays (History and Guide) */
        #overlayHistory, #overlayGuide {
            position:fixed;
            top:0; left:0;
            width:100%; height:100%;
            backdrop-filter:blur(10px);
            background:rgba(255,255,255,0.05);
            display:none;
            justify-content:center;
            align-items:center;
            padding:1rem;
            z-index:20;
        }

        .overlayBox {
            width:90%; max-width:500px;
            background:rgba(30,30,30,0.95);
            border-radius:12px;
            padding:1.5rem;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
        }
        .overlayBox h3 { margin-bottom: 1rem; }
        .overlayBox button {
            background:#007aff;
            color:white;
            border:none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 1rem;
            align-self: flex-start;
        }
        #historyList {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
            border-top: 1px solid #333;
            padding-top: 10px;
            flex-grow: 1; 
        }
        #historyList div {
            padding: 5px 0;
            border-bottom: 1px dashed #222;
            font-size: 0.9em;
        }

        /* Main Chat Area */
        #chatContainer {
            flex:1;
            display:flex;
            flex-direction:column;
            padding:0 1rem;
            overflow:hidden;
        }

        /* Quick Suggestions */
        #quickSuggestions {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 15px;
            padding: 1rem;
            margin-top: auto; 
            max-width: 600px; 
            width: 100%;
            align-self: center; 
        }

        .suggest-btn {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            text-align: center;
            transition: background 0.3s, border-color 0.3s;
        }
        .suggest-btn:hover {
            background: #2a2a2a;
            border-color: #555;
        }

        /* Chat Messages Display */
        #chatMessages {
            flex:1;
            overflow-y:auto;
            padding-top:1rem;
            padding-right:1rem;
            display: flex;
            flex-direction: column;
        }
        #chatMessages div {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }
        #chatMessages div strong {
            display: block;
            margin-bottom: 4px;
            font-size: 0.9em;
            font-weight: bold;
        }
        /* Style for Bot messages */
        .bot-message {
            background: #2a2a2a;
            align-self: flex-start;
            text-align: left;
        }
        /* Style for User messages */
        .user-message {
            background: #007aff;
            margin-left: auto;
            align-self: flex-end;
            text-align: left;
        }

        /* Input Area */
        #inputArea {
            display:flex;
            gap:0.5rem;
            padding:1rem; 
            background:#000;
        }

        #input {
            flex:1;
            padding:0.7rem;
            border:none;
            border-radius:6px;
            outline:none;
            background: #222;
            color: #fff;
        }

        #send {
            padding:0.7rem 1rem;
            background:#007aff;
            border:none;
            color:white;
            border-radius:6px;
            cursor:pointer;
            transition: background 0.3s;
        }
        #send:hover {
            background: #005bb5;
        }

    </style>
</head>
<body>

<header>
    <div id="leftIcons">
        <span id="commentIcon">üí¨ History</span>
    </div>
    <div id="userGuide">‚ùî User Guide</div>
</header>

<div id="overlayHistory">
    <div class="overlayBox">
        <h3>Chat History (Latest at Top)</h3>
        <div id="historyList"></div>
        <button onclick="closeHistory()">Close</button>
    </div>
</div>

<div id="overlayGuide">
    <div class="overlayBox">
        <h3>User Guide</h3>
        <p>üí¨ How to Use
- Type your message in the chat box.
- Example:
- ‚ÄúI feel happy today!‚Äù
- ‚ÄúSuggest songs like Taylor Swift.‚Äù
- ‚ÄúI‚Äôm in a chill mood.‚Äù
- Send your message by clicking the Send button or pressing Enter.
- The chatbot will show ‚ÄòThinking‚Ä¶‚Äô while preparing your recommendations.
- You‚Äôll receive a list of songs with:
- üé∂ Song Title
- üë©‚Äçüé§ Artist Name
- üîó Spotify, Apple Music, and YouTube link



üí° Tips for Best Experience
- Be specific about your mood or artist for tailored recommendations.
- Example: ‚ÄúI want energetic workout songs.‚Äù
- Try different moods to discover new music styles.
- Use the links to explore songs directly on your favorite platform.
</p>
        <button onclick="closeGuide()">Close</button>
    </div>
</div>

<div id="chatContainer">
    <div id="chatMessages"></div>

    <div id="quickSuggestions">
        <div class="suggest-btn" onclick="sendSuggestedMessage(this)"></div>
        <div class="suggest-btn" onclick="sendSuggestedMessage(this)"></div>
        <div class="suggest-btn" onclick="sendSuggestedMessage(this)"></div>
        <div class="suggest-btn" onclick="sendSuggestedMessage(this)"></div>
    </div>

    <div id="inputArea">
        <input id="input" placeholder="Type your mood or favorite song..." />
        <button id="send">Send</button>
    </div>
</div>

<script>

    const BOT_NAME = "Twenty35";
    const sendBtn = document.getElementById('send');
    const userInput = document.getElementById('input');
    const chatMessages = document.getElementById('chatMessages');
    const historyList = document.getElementById('historyList');
    const quickSuggestionsContainer = document.getElementById('quickSuggestions');
    const suggestBtns = quickSuggestionsContainer.querySelectorAll('.suggest-btn');


    // Overlays
    const overlayHistory = document.getElementById('overlayHistory');
    const overlayGuide = document.getElementById('overlayGuide');

    // Quick Chat Suggestions
    const quickSuggestions = [
        "I'm feeling happy, recommend some upbeat songs!",
        "What are some relaxing Japanese songs?",
        "Suggest some Burmese folk music.",
        "I like rock music, any English band recommendations?",
        "Recommend songs for studying.",
        "What are some good K-pop songs right now?",
        "I need some motivational music.",
        "Suggest songs for a workout.",
        "What's a good song for a road trip?",
        "Recommend some instrumental music.",
        "I'm in the mood for some sad songs.",
        "Suggest some classical music.",
        "What's popular in Burmese music charts?",
        "Give me some chill lo-fi recommendations."
    ];

    // Overlay Event Listeners
    document.getElementById('commentIcon').onclick = ()=>{
        overlayHistory.style.display = 'flex';
    };
    document.getElementById('userGuide').onclick = ()=>{
        overlayGuide.style.display = 'flex';
    };

    function closeHistory(){ overlayHistory.style.display = 'none'; }
    function closeGuide(){ overlayGuide.style.display = 'none'; }

    // Function to display random quick suggestions
    function displayRandomSuggestions() {
        // Shuffle the array to get random suggestions
        const shuffled = [...quickSuggestions].sort(() => 0.5 - Math.random());
        // Take the first 4 for display
        const selectedSuggestions = shuffled.slice(0, 4);

        suggestBtns.forEach((btn, index) => {
            if (selectedSuggestions[index]) {
                btn.textContent = selectedSuggestions[index];
                btn.style.display = 'block'; 
            } else {
                btn.style.display = 'none'; 
            }
        });
        
      
        
        // The quickSuggestionsContainer should be visible ONLY at the start.
        if (chatMessages.children.length <= 1) { // 1 for the initial welcome message
             quickSuggestionsContainer.style.display = 'grid';
        } else {
             quickSuggestionsContainer.style.display = 'none';
        }
    }

    // Function to handle clicking a suggestion box
    function sendSuggestedMessage(element) {
        userInput.value = element.textContent;
        sendMessage();
    }


    // 1. **FIX: INITIALIZATION** - Call displayRandomSuggestions() BEFORE the first welcome message is added.
    if(!chatMessages.hasChildNodes()){
        displayRandomSuggestions(); 
        addMessage(BOT_NAME, "Hi! Tell me your mood or favorite songs, and I‚Äôll recommend music ‚Äî English / Japanese / Burmese!", 'bot-message');
    }


    // Core functions
    async function sendMessage(){
        const message = userInput.value.trim();
        if(!message) return;
        
        // 2. **FIX: HIDING** - Hide suggestions immediately when the user sends a message.
        quickSuggestionsContainer.style.display = 'none';

        addMessage("You", message, 'user-message');
        saveHistory(`You: ${message}`);
        userInput.value = "";

        const loadingId = addMessage(BOT_NAME, "Thinking", 'bot-message');
        const dotsInterval = startThinkingAnimation(loadingId);

        try{
            const systemMessage = `You are a music recommendation chatbot named Twenty35.
Always respond in the same language as the user input (English / Japanese / Burmese).
Recommend 3‚Äì5 songs based on the user's mood or input.
For each song, include hypothetical links for Spotify, Apple Music, and YouTube (e.g., "[Spotify Link]").`;

            const response = await fetch("/.netlify/functions/openai-proxy", {
                method: "POST",
                headers: { "Content-Type":"application/json" },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [
                        { role: "system", content: systemMessage },
                        { role: "user", content: message }
                    ]
                })
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }

            const data = await response.json();
            const botMessage = data.choices[0].message.content; 
            
            clearInterval(dotsInterval);
            updateMessage(loadingId, botMessage);
            saveHistory(`${BOT_NAME}: ${botMessage}`);

        }catch(err){
            console.error("Fetch error:", err);
            clearInterval(dotsInterval);
            updateMessage(loadingId, "Oops! Something went wrong. The AI service may be unavailable.");
        }
    }

    function addMessage(sender, text, className){
        let id = `msg-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`; 
        
        const messageDiv = document.createElement('div');
        messageDiv.id = id;
        messageDiv.classList.add(className);
        messageDiv.innerHTML = `<strong>${sender}:</strong> <p>${text}</p>`;
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return id;
    }

    function updateMessage(id, text){
        const msg = document.getElementById(id);
        if(!msg) return;
        msg.innerHTML = `<strong>${BOT_NAME}:</strong> <p>${text}</p>`;
    }

    function startThinkingAnimation(id){
        let dots = 0;
        return setInterval(()=>{
            const msg = document.getElementById(id);
            if(!msg) return;
            dots = (dots+1)%4;
            msg.innerHTML = `<strong>${BOT_NAME}:</strong> Thinking${'.'.repeat(dots)}`; 
        },500);
    }

    function saveHistory(msg){
        const div = document.createElement('div');
        div.textContent = msg;
        div.style.marginBottom = '8px';
        historyList.prepend(div); 
    }

    sendBtn.onclick = sendMessage;
    userInput.addEventListener('keypress', e=>{ 
        if(e.key==='Enter') sendMessage(); 
    });

</script>
</body>
</html>