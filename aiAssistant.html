<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

  <title>Twenty35 Music (home)</title>
  <link rel="stylesheet" href="css/aiAssistant.css">
  <link rel="stylesheet" href="css/style.css">
<link href="https://fonts.googleapis.com/css2?family=Fugaz+One&family=Kaisei+Tokumin&family=Shrikhand&family=Inter&family=Noto+Sans+JP&family=Padauk&display=swap" rel="stylesheet">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Myanmar:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet"><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Myanmar:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

       
</head>
<body class="aiAssistantBody">

    <div class="sidebar" id="sidebar">
    <h2 ><a href="index.html">Twenty<span style="color:  #1ED760;">35</span> </a></h2>
    <a data-i18n="nav1" class="nav" href="index.html"> Home</a>
    <a data-i18n="nav2" class="nav" href="favartists.html"> My Fav Artists</a>
    <a data-i18n="nav3" class="nav" href="songRecommendation.html"> Song Recommendations</a>
    <a data-i18n="nav4" class="nav" href="myPlaylist.html">My Playlists</a>
    <a data-i18n="nav5" class="nav current_nav" href="aiAssistant.html">AI assistant</a> 

     <div id="mobileExtras"></div>
  </div>

  <!-- Main Content -->
  <div class="main">
    <div class="hamburger" id="hamburger">&#9776;</div>

    <div class="tobBar" id="tobBar">
  <div id="modebutton">
    <div class="toggle-switch" id="modeSwitch">
      <div class="slider"></div>
    </div>
    <div class="toggle-label" id="modeLabel">Dark Mode</div>
  </div>

  <div id="langSwitch">
    <select id="language-select" onchange="setLanguage(this.value)">
      <option value="en">&#x1F310;English</option>
      <option value="ja">&#x1F310;æ—¥æœ¬èª</option>
      <option value="my">&#x1F310;á€™á€¼á€”á€ºá€™á€¬</option>
    </select>
  </div>

  <div id="profile">ğŸ‘¤</div>
</div>

    <div class="title">Twenty<span style="color:  #1ED760;">35</span> AI</div> 


<header>
   <div id="leftIcons">
        <span id="commentIcon">ğŸ’¬ History</span>
    </div>
    <div id="userGuide">â” User Guide</div>
</header>

<div id="overlayHistory">
    <div class="overlayBox">
        <h3>Chat History (Latest at Top)</h3>
        <div id="historyList"></div>
        <button onclick="closeHistory()">Close</button>
    </div>
</div>

<div id="overlayGuide">
    <div class="overlayBox">
        <h3>User Guide</h3>
        <p>ğŸ’¬ How to Use
- Type your message in the chat box.
- Example:
- â€œI feel happy today!â€
- â€œSuggest songs like Taylor Swift.â€
- â€œIâ€™m in a chill mood.â€
- Send your message by clicking the Send button or pressing Enter.
- The chatbot will show â€˜Thinkingâ€¦â€™ while preparing your recommendations.
- Youâ€™ll receive a list of songs with:
- ğŸ¶ Song Title
- ğŸ‘©â€ğŸ¤ Artist Name
- ğŸ”— Spotify, Apple Music, and YouTube link



ğŸ’¡ Tips for Best Experience
- Be specific about your mood or artist for tailored recommendations.
- Example: â€œI want energetic workout songs.â€
- Try different moods to discover new music styles.
- Use the links to explore songs directly on your favorite platform.
</p>
        <button onclick="closeGuide()">Close</button>
    </div>
</div>

<div id="chatContainer">
    <div id="chatMessages"></div>

    <div id="quickSuggestions">
        <div class="suggest-btn" onclick="sendSuggestedMessage(this)"></div>
        <div class="suggest-btn" onclick="sendSuggestedMessage(this)"></div>
        <div class="suggest-btn" onclick="sendSuggestedMessage(this)"></div>
        <div class="suggest-btn" onclick="sendSuggestedMessage(this)"></div>
    </div>

    <div id="inputArea">
        <input id="input" placeholder="Tell me how you feel..." />
        <button id="send">Send</button>
    </div>
</div>

</div>

<script>

    const BOT_NAME = "Twenty35";
    const sendBtn = document.getElementById('send');
    const userInput = document.getElementById('input');
    const chatMessages = document.getElementById('chatMessages');
    const historyList = document.getElementById('historyList');
    const quickSuggestionsContainer = document.getElementById('quickSuggestions');
    const suggestBtns = quickSuggestionsContainer.querySelectorAll('.suggest-btn');


    // Overlays
    const overlayHistory = document.getElementById('overlayHistory');
    const overlayGuide = document.getElementById('overlayGuide');

    // Quick Chat Suggestions
    const quickSuggestions = [
        "I'm feeling happy, recommend some upbeat songs!",
        "What are some relaxing Japanese songs?",
        "Suggest some Burmese folk music.",
        "I like rock music, any English band recommendations?",
        "Recommend songs for studying.",
        "What are some good K-pop songs right now?",
        "I need some motivational music.",
        "Suggest songs for a workout.",
        "What's a good song for a road trip?",
        "Recommend some instrumental music.",
        "I'm in the mood for some sad songs.",
        "Suggest some classical music.",
        "What's popular in Burmese music charts?",
        "Give me some chill lo-fi recommendations."
    ];

    // Overlay Event Listeners
    document.getElementById('commentIcon').onclick = ()=>{
        overlayHistory.style.display = 'flex';
    };
    document.getElementById('userGuide').onclick = ()=>{
        overlayGuide.style.display = 'flex';
    };

    function closeHistory(){ overlayHistory.style.display = 'none'; }
    function closeGuide(){ overlayGuide.style.display = 'none'; }

    // Function to display random quick suggestions
    function displayRandomSuggestions() {
        // Shuffle the array to get random suggestions
        const shuffled = [...quickSuggestions].sort(() => 0.5 - Math.random());
        // Take the first 4 for display
        const selectedSuggestions = shuffled.slice(0, 4);

        suggestBtns.forEach((btn, index) => {
            if (selectedSuggestions[index]) {
                btn.textContent = selectedSuggestions[index];
                btn.style.display = 'block'; 
            } else {
                btn.style.display = 'none'; 
            }
        });
        
        if (chatMessages.children.length <= 1) { 
             quickSuggestionsContainer.style.display = 'grid';
        } else {
             quickSuggestionsContainer.style.display = 'none';
        }
    }

    // Function to handle clicking a suggestion box
    function sendSuggestedMessage(element) {
        userInput.value = element.textContent;
        sendMessage();
    }


    // INITIALIZATION: Display suggestions, then add the welcome message.
    if(!chatMessages.hasChildNodes()){
        displayRandomSuggestions(); 
        addMessage(BOT_NAME, "Hi! Tell me your mood or favorite songs, and Iâ€™ll recommend music â€” English / Japanese / Burmese!", 'bot-message');
    }


    // Core functions
    async function sendMessage(){
        const message = userInput.value.trim();
        if(!message) return;
        
        quickSuggestionsContainer.style.display = 'none';

        addMessage("You", message, 'user-message');
        saveHistory(`You: ${message}`);
        userInput.value = "";

        const loadingId = addMessage(BOT_NAME, "Thinking", 'bot-message');
        const dotsInterval = startThinkingAnimation(loadingId);

        try{

   const systemMessage = `You are a music recommendation chatbot named Twenty35.
Always respond in the same language as the user input (English / Japanese / Burmese).
Recommend 3â€“5 songs based on the user's mood, feelings, or favorite artists.
For each recommendation, ALWAYS include:
1. Song title
2. Artist name
3. Spotify search link
4. Apple Music search link
5. YouTube search link
Give sweet messages for users, depend on user's mood.
IMPORTANT: Format ALL links using standard Markdown syntax: [Link Name](URL). Example: [Spotify Link](http://spotify.com/search?q=song) and include a newline after each song/link grouping.`;

            const response = await fetch("/.netlify/functions/openai-proxy", {
                method: "POST",
                headers: { "Content-Type":"application/json" },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [
                        { role: "system", content: systemMessage },
                        { role: "user", content: message }
                    ]
                })
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }

            const data = await response.json();
            const botMessage = data.choices[0].message.content; 
            
            clearInterval(dotsInterval);
            updateMessage(loadingId, botMessage);
            saveHistory(`${BOT_NAME}: ${botMessage}`);

        }catch(err){
            console.error("Fetch error:", err);
            clearInterval(dotsInterval);
            updateMessage(loadingId, "Oops! Something went wrong. The AI service may be unavailable.");
        }
    }

    // --- MODIFIED FUNCTION ---
    function addMessage(sender, text, className){
        // 1. Convert Markdown links to HTML links
        let htmlText = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
        
        // 2. Split lines based on newline or start of a numbered list item
        const lines = htmlText.split(/\n|(?=\d+\.)/);
        
        // 3. Trim, filter empty, wrap in <p> tags, and join
        const formattedText = lines
            .map(l => l.trim())
            .filter(l => l)
            .map(l => `<p>${l}</p>`)
            .join("");

        const id = `msg-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`; 
        
        const messageDiv = document.createElement('div');
        messageDiv.id = id;
        messageDiv.classList.add(className); 
        
        // 4. Insert the formatted HTML
        messageDiv.innerHTML = `<strong>${sender}:</strong>${formattedText}`; 
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return id;
    }

    // --- MODIFIED FUNCTION ---
    function updateMessage(id, text){
        const msgDiv = document.getElementById(id);
        if(!msgDiv) return;
        
        // 1. Convert Markdown links to HTML links
        let htmlText = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
        
        // 2. Split lines based on newline or start of a numbered list item
        const lines = htmlText.split(/\n|(?=\d+\.)/);
        
        // 3. Trim, filter empty, wrap in <p> tags, and join
        const formattedText = lines
            .map(l => l.trim())
            .filter(l => l)
            .map(l => `<p>${l}</p>`)
            .join("");

        // 4. Update the content
        msgDiv.innerHTML = `<strong>${BOT_NAME}:</strong>${formattedText}`;
    }

    function startThinkingAnimation(id){
        let dots = 0;
        return setInterval(()=>{
            const msg = document.getElementById(id);
            if(!msg) return;
            dots = (dots+1)%4;
            msg.innerHTML = `<strong>${BOT_NAME}:</strong> Thinking${'.'.repeat(dots)}`; 
        },500);
    }

    function saveHistory(msg){
        const div = document.createElement('div');
        div.textContent = msg;
        div.style.marginBottom = '8px';
        historyList.prepend(div); 
    }

    sendBtn.onclick = sendMessage;
    userInput.addEventListener('keypress', e=>{ 
        if(e.key==='Enter') sendMessage(); 
    });

</script>


<script src="js/script.js"></script>
<script src="js/lang.js"></script>
<script src="js/ai.js"></script>

</body>
</html>